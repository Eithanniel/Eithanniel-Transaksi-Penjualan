<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Tokopeedia</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* wrapper keeps the badge out of the document flow */
.card-wrap {
  position: relative;
  width: 100%;
}

/* Absolute pulsing badge (won't change layout) */
.best-selling {
  position: absolute;
  top: -12px;                 /* sits above the card */
  left: 50%;
  transform: translateX(-50%);
  z-index: 3;
  font-weight: 700;
  font-size: 0.95rem;
  color: #fff;
  background: linear-gradient(90deg,#ff6a00,#ffb347);
  padding: 4px 10px;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  animation: pulseText 1.5s infinite ease-in-out;
  pointer-events: none;       /* badge won't block clicks */
}

/* pulse keyframes for badge */
@keyframes pulseText {
  0%,100% { transform: translateX(-50%) scale(1); opacity: 1; }
  50%     { transform: translateX(-50%) scale(1.25); opacity: 0.85; }
}

/* chroma-body (keeps aura behind text) */
.chroma-body {
  position: relative;
  z-index: 1;                 /* creates stacking context so ::before sits behind content */
}

.chroma-body::before {
  content: "";
  position: absolute;
  inset: -6px;
  border-radius: 8px;
  background: conic-gradient(
    from 0deg,
    red, orange, yellow, lime, cyan, blue, violet, red
  );
  filter: blur(10px);
  z-index: -1;
  pointer-events: none;
  animation: chromaSpin 6s linear infinite;
}

@keyframes chromaSpin {
  0%   { transform: rotate(0deg); }
  100% { transform: rotate(0deg); }
}

</style>


</head>
<body class="p-4 bg-primary bg-opacity-50">

  <div class="container">
    <h2 class="text-center mb-4">üõçÔ∏è Transaksi Penjualan</h2>

    <!-- Produk List -->
    <div id="produkGrid" class="row g-4 mb-5"></div>

    <!-- Keranjang -->
    <h4>üõí Keranjang Belanja</h4>
    <table class="table table-bordered bg-white">
      <thead>
        <tr class = "table-info">
          <th>Produk</th>
          <th>Jumlah</th>
          <th>Harga</th>
          <th>Subtotal</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="keranjangList"></tbody>
      <tfoot>
        <tr class = "table-success">
          <td colspan="3" class="text-end "><b>Total</b></td>
          <td colspan="2" id="totalHarga"><b>Rp 0</b></td>
        </tr>
      </tfoot>
    </table>

    <!-- Simpan -->
    <div class="d-flex align-items-center gap-3">
      <button class="btn btn-success" onclick="simpanTransaksi()">üíæ Simpan Transaksi</button>
      <span class="fw-bold">Eithanniel Benedict Saputra XII-4</span>
    </div>
  </div>

<script>
  const SUPABASE_URL = "https://ioehaawreyvmcgiuuewu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZWhhYXdyZXl2bWNnaXV1ZXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQ0MjksImV4cCI6MjA3MzA0MDQyOX0.97onhyF612fTWvUopc-ErcWVQ5OSk2mEbBJdN7zWvOg";
  const { createClient } = supabase;
  const db = createClient(SUPABASE_URL, SUPABASE_KEY);

  let produkData = [];
  let keranjang = [];

  // Muat produk dari database
  async function loadProduk() {
    const { data, error } = await db.from("produk").select("*");
    if (error) {
      Swal.fire("Error", "Gagal memuat produk: " + error.message, "error");
      return;
    }
    produkData = data;
    renderProduk();
  }

 function renderProduk() {
  const grid = document.getElementById("produkGrid");
  grid.innerHTML = "";
  produkData.forEach(item => {
    let col = document.createElement("div");
    // make column a flex container so cards stretch to same height
    col.className = "col-md-3 d-flex";

    const isSecret = item.kategori === "secret";

    col.innerHTML = `
      <div class="card-wrap w-100">
        ${isSecret ? '<div class="best-selling">üî• Best Selling!</div>' : ''}
        <div class="card h-100 shadow-sm">
          <img src="${item.gambar || 'https://via.placeholder.com/200'}" class="card-img-top" alt="${item.nama}">
          <div class="card-body d-flex flex-column ${isSecret ? 'chroma-body' : ''}">
            <h6 class="card-title">${item.nama}</h6>
            <p class="mb-1 text-muted">Rp ${Number(item.harga).toLocaleString()}</p>
            <p class="mb-1"><b>Stock:</b> ${item.stok}</p>
            <input type="number" min="1" value="1" class="form-control mb-2" id="qty-${item.id}">
            <button class="btn btn-primary mt-auto" onclick="tambahKeranjang(${item.id})">Add to Cart</button>
          </div>
        </div>
      </div>
    `;
    grid.appendChild(col);
  });
}


function tambahKeranjang(idProduk) {
  let produk = produkData.find(p => p.id == idProduk);
  let qtyInput = document.getElementById("qty-" + idProduk);
  let jumlah = parseInt(qtyInput.value);

  if (!jumlah || jumlah <= 0) {
    Swal.fire("Oops!", "Jumlah harus lebih dari 0", "warning");
    return;
  }

  // ‚úÖ Cek stok
  if (jumlah > produk.stok) {
    Swal.fire("Oops!", `Stock hanya ${produk.stok}, kamu pesan ${jumlah}!`, "error");
    return;
  }

  let existing = keranjang.find(item => item.id === idProduk);
  if (existing) {
    if (existing.jumlah + jumlah > produk.stok) {
      Swal.fire("Oops!", `Stock hanya ${produk.stok}, kamu sudah ambil ${existing.jumlah}!`, "error");
      return;
    }
    existing.jumlah += jumlah;
    existing.subtotal = existing.jumlah * existing.harga;
  } else {
    keranjang.push({
      id: produk.id,
      nama: produk.nama,
      harga: produk.harga,
      jumlah,
      subtotal: produk.harga * jumlah
    });
  }
  renderKeranjang();
}


  // Render isi keranjang
  function renderKeranjang() {
    const tbody = document.getElementById("keranjangList");
    tbody.innerHTML = "";
    let total = 0;
    keranjang.forEach((item, index) => {
      total += item.subtotal;
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.nama}</td>
        <td>${item.jumlah}</td>
        <td>Rp ${Number(item.harga).toLocaleString()}</td>
        <td>Rp ${Number(item.subtotal).toLocaleString()}</td>
        <td><button class="btn btn-danger btn-sm" onclick="hapusItem(${index})">Hapus</button></td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById("totalHarga").innerHTML = "<b>Rp " + Number(total).toLocaleString() + "</b>";
  }

  function hapusItem(index) {
    keranjang.splice(index, 1);
    renderKeranjang();
  }

// Simpan transaksi
async function simpanTransaksi() {
  if (keranjang.length === 0) {
    Swal.fire("Oops!", "Keranjang masih kosong", "warning");
    return;
  }

  // ‚úÖ Cek stok terbaru dari database (biar aman)
  for (let item of keranjang) {
    let { data: produk, error } = await db.from("produk").select("stok").eq("id", item.id).single();
    if (error) {
      Swal.fire("Error", "Gagal cek stok: " + error.message, "error");
      return;
    }
    if (!produk || item.jumlah > produk.stok) {
      Swal.fire("Oops!", `${item.nama} hanya sisa ${produk.stok}, tapi kamu pesan ${item.jumlah}`, "error");
      return;
    }
  }

  // ‚úÖ Simpan transaksi
  const { error: insertError } = await db.from("transaksi").insert([{
    tanggal: new Date().toISOString(),
    items: keranjang,
    total: keranjang.reduce((a, b) => a + b.subtotal, 0)
  }]);

  if (insertError) {
    Swal.fire("Error", "Gagal menyimpan transaksi: " + insertError.message, "error");
    return;
  }

// ‚úÖ Update stok setiap produk
for (let item of keranjang) {
  // ambil stok terbaru dulu
  let { data: produk, error: getError } = await db.from("produk").select("stok").eq("id", item.id).single();
  if (getError) {
    Swal.fire("Error", "Gagal ambil stok: " + getError.message, "error");
    return;
  }

  let stokBaru = produk.stok - item.jumlah;

  const { error: updateError } = await db
    .from("produk")
    .update({ stok: stokBaru })
    .eq("id", item.id);

  if (updateError) {
    Swal.fire("Error", `Gagal update stok untuk ${item.nama}: ` + updateError.message, "error");
    return;
  }
}


  Swal.fire("Sukses", "Transaksi berhasil disimpan & stok diperbarui", "success");
  keranjang = [];
  renderKeranjang();
  loadProduk(); 
}
loadProduk()
</script>
</body>
</html>
